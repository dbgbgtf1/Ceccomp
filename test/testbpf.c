// this is for separately function testing
// #include "main.h"
#include "main.h"
#include "transfer.h"
#include <linux/audit.h>
#include <linux/filter.h>
#include <linux/seccomp.h>
#include <seccomp.h>
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <unistd.h>

#define ARRAY_SIZE(arr) (sizeof (arr) / sizeof (arr[0]))

void
load_filter (uint32_t t_arch)
{
  unsigned int upper_nr_limit = 0xffffffff;
  prctl (PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);
  /* Assume that AUDIT_ARCH_X86_64 means the normal x86-64 ABI
     (in the x32 ABI, all system calls have bit 30 set in the
     'nr' field, meaning the numbers are >= X32_SYSCALL_BIT). */

  char f[]
      = "\x20\x00\x00\x00\x04\x00\x00\x00\x15\x00\x00\x3c\x3e\x00\x00\xc0\x20"
        "\x00\x00\x00\x00\x00\x00\x00\x35\x00\x3a\x00\x00\x00\x00\x40\x15\x00"
        "\x38\x00\x00\x00\x00\x00\x15\x00\x37\x00\x01\x00\x00\x00\x15\x00\x36"
        "\x00\x03\x00\x00\x00\x15\x00\x35\x00\x0b\x00\x00\x00\x15\x00\x34\x00"
        "\x18\x00\x00\x00\x15\x00\x33\x00\x20\x00\x00\x00\x15\x00\x32\x00\x21"
        "\x00\x00\x00\x15\x00\x31\x00\x23\x00\x00\x00\x15\x00\x30\x00\x2a\x00"
        "\x00\x00\x15\x00\x2f\x00\x2b\x00\x00\x00\x15\x00\x2e\x00\x2f\x00\x00"
        "\x00\x15\x00\x2d\x00\x31\x00\x00\x00\x15\x00\x2c\x00\x3c\x00\x00\x00"
        "\x15\x00\x2b\x00\xe7\x00\x00\x00\x15\x00\x00\x04\x38\x00\x00\x00\x20"
        "\x00\x00\x00\x14\x00\x00\x00\x15\x00\x00\x29\x00\x00\x00\x00\x20\x00"
        "\x00\x00\x10\x00\x00\x00\x15\x00\x26\x27\x00\x09\x01\x00\x15\x00\x00"
        "\x0c\x29\x00\x00\x00\x20\x00\x00\x00\x14\x00\x00\x00\x15\x00\x00\x24"
        "\x00\x00\x00\x00\x20\x00\x00\x00\x10\x00\x00\x00\x15\x00\x00\x22\x02"
        "\x00\x00\x00\x20\x00\x00\x00\x1c\x00\x00\x00\x15\x00\x00\x20\x00\x00"
        "\x00\x00\x20\x00\x00\x00\x18\x00\x00\x00\x15\x00\x00\x1e\x01\x00\x00"
        "\x00\x20\x00\x00\x00\x24\x00\x00\x00\x15\x00\x00\x1c\x00\x00\x00\x00"
        "\x20\x00\x00\x00\x20\x00\x00\x00\x15\x00\x19\x1a\x00\x00\x00\x00\x15"
        "\x00\x00\x19\x09\x00\x00\x00\x20\x00\x00\x00\x14\x00\x00\x00\x15\x00"
        "\x00\x17\x00\x00\x00\x00\x20\x00\x00\x00\x10\x00\x00\x00\x15\x00\x00"
        "\x15\x00\x00\x00\x00\x20\x00\x00\x00\x1c\x00\x00\x00\x15\x00\x00\x13"
        "\x00\x00\x00\x00\x20\x00\x00\x00\x18\x00\x00\x00\x15\x00\x00\x11\x00"
        "\x10\x00\x00\x20\x00\x00\x00\x24\x00\x00\x00\x15\x00\x00\x0f\x00\x00"
        "\x00\x00\x20\x00\x00\x00\x20\x00\x00\x00\x15\x00\x00\x0d\x03\x00\x00"
        "\x00\x20\x00\x00\x00\x2c\x00\x00\x00\x15\x00\x00\x0b\x00\x00\x00\x00"
        "\x20\x00\x00\x00\x28\x00\x00\x00\x15\x00\x00\x09\x22\x00\x00\x00\x20"
        "\x00\x00\x00\x34\x00\x00\x00\x15\x00\x00\x07\x00\x00\x00\x00\x20\x00"
        "\x00\x00\x30\x00\x00\x00\x15\x00\x00\x05\x00\x00\x00\x00\x20\x00\x00"
        "\x00\x3c\x00\x00\x00\x15\x00\x00\x03\x00\x00\x00\x00\x20\x00\x00\x00"
        "\x38\x00\x00\x00\x15\x00\x00\x01\x00\x00\x00\x00\x06\x00\x00\x00\x00"
        "\x00\xff\x7f\x06\x00\x00\x00\x00\x00\x00\x00";

  struct sock_fprog prog
      = { .len = ARRAY_SIZE (f) / sizeof (filter), .filter = (filter *)f };

  int pid = fork ();

  syscall (SYS_seccomp, SECCOMP_SET_MODE_FILTER, NULL, &prog);

  write (1, "this is program output\n", 24);
  if (pid == 0)
    sleep (0x100);
}

int
main ()
{
  uint32_t arch = SCMP_ARCH_X86_64;

  perror ("this is stderr msg");
  puts ("this is stdout msg");
  load_filter (arch);
}
